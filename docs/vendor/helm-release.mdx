import RepositoryCicdNote from "../partials/releases/_repository-cicd-note.mdx"
import CreateReleaseUi from "../partials/releases/_create-release-ui.mdx"
import PrereqsCli from "../partials/releases/_prereqs-cli.mdx"


# Creating Releases with Helm Charts

This topic describes how to add a Helm chart to a release in the Replicated vendor portal or the replicated CLI. Adding a Helm chart to a release is useful if you want to distribute a Kubernetes application with Replicated that is already packaged using Helm.

This procedure applies for Replicated Helm installations and native Helm installations. For more information, see [Helm Overview](helm-overview).

## About Releasing with Helm Charts

You can add one or more Helm charts to a release in the vendor portal by uploading each Helm chart as a `.tgz` package. This allows you to use Replicated to distribute applications that are packaged with Helm.

When you add a Helm chart to a release, Replicated adds a copy of the `Chart.yaml` file and the `values.yaml` file from the Helm chart to the release.

You must also have a HelmChart custom resource manifest file in the release for each Helm chart that you add. You use this HelmChart custom resource to configure the Helm chart with your application.

The following table provides more information about these files:

<table>
<tr>
  <th width="30%">File</th>
  <th>Description</th>
</tr>
<tr>
  <td>HelmChart custom resource</td>
  <td>A HelmChart custom resource is a YAML file with <code>kind: HelmChart</code>.
  <br/>
  <br/>
  When you drag and drop a Helm chart <code>.tgz</code> to a release in the vendor portal, Replicated automatically creates a corresponding HelmChart custom resource manifest that uses the naming convention <code>CHART_NAME.yaml</code>. For example, <code>postgresql.yaml</code>.
  <br/>
  <br/>
  The HelmChart custom resource references the <code>.tgz</code> export of the Helm chart and provides the necessary instructions to the Replicated app manager for processing and preparing the chart for deployment.
  <br/>
  <br/>
  For more information, see <a href="../reference/custom-resource-helmchart">HelmChart</a> in the <em>Custom Resources</em> section.</td>
</tr>
<tr>
  <td>Chart.yaml</td>
  <td>Replicated extracts the <code>Chart.yaml</code> file from the Helm chart <code>.tgz</code> file that you provide. This file is read-only and cannot be edited in the release.</td>
</tr>
<tr>
  <td>values.yaml</td>
  <td>Replicated extracts the <code>values.yaml</code> file from the Helm chart <code>.tgz</code> file that you provide. This file is read-only and cannot be edited in the release.</td>
</tr>
</table>

For example, the following screenshot shows how a Postgres Helm chart displays in the file tree of a release in the vendor portal:

![Postgres Helm Chart](/images/postgres-helm-chart.png)

## Package a Helm Chart

To include a Helm chart in a release, first package the Helm chart, including any of its dependencies, as a `.tgz` file. Then, add the `.tgz` Helm chart package to your release.

There are different steps for creating the Helm chart package depending on if the Helm chart source is in a remote chart repository such as Artifact Hub, or in a local directory.

For more information about the Helm CLI commands in this procedure, see the [Helm Commands](https://helm.sh/docs/helm/helm/) section in the Helm documentation.

To package a Helm chart and add it to a release:

1. If the Helm chart source is in a chart repository, do the following:

   1. Update your local directory with the latest available Helm chart information from your chart repositories. Run:

      ```
      helm repo update
      ```
      :::note
      You can also pass the names of a specific repository or repositories that you want to update in the `helm repo update` command. For more information, see [Helm Repo Update](https://helm.sh/docs/helm/helm_repo_update/) in the Helm documentation.
      :::
   1. Download the latest copy of the desired Helm chart from a repository. Run:

      ```
      helm fetch REPO_NAME/CHART_NAME
      ```
      Replace:
      * `REPO_NAME` with the name of the repository where the Helm chart is located.
      * `CHART_NAME` with the name of the Helm chart as it appears in the repository.

      The Helm chart, including any dependencies, is packaged and copied to your current directory in a `.tgz` file. The file uses the naming convention: `CHART_NAME-VERSION.tgz`. For example, `postgresql-8.1.2.tgz`.

1. If the Helm chart source is in your local directory, do the following:

   1. In your local directory, `cd` to the location of the `Chart.yaml` file for the Helm chart.

   1. If the `Chart.yaml` file includes any dependencies, update the `charts/` directory. Run:

      ```
      helm dependency update
      ```
   1. Package the Helm chart. Run:

      ```
      helm package .
      ```

      The Helm chart, including any dependencies, is packaged and copied to your current directory in a `.tgz` file. The file uses the naming convention: `CHART_NAME-VERSION.tgz`. For example, `postgresql-8.1.2.tgz`.

Next, create and promote a release using one of the following methods:

- [Using the Vendor Portal](#ui)

- [Using the CLI](#cli)

## Using the Vendor Portal {#ui}

When you create a release in the vendor portal, Replicated automatically creates the HelmChart custom resource manifest file for the Helm chart when you drag and drop your Helm chart `.tgz` file from your local directory to the file tree in the vendor portal.

To create and promote a release in the vendor portal:

1. From the **Applications** dropdown list, select **Create an app** or select an existing application to update.

1. Click **Releases** on the left menu, and click **Create release**.

  ![Create Release](/images/release-create-new.png)

  [View a larger image](/images/release-create-new.png)

1. For the first release of an application, drag and drop your application files into the file directory in the YAML editor.

  If you are editing a draft or an existing non-promoted release, the files appear in the YAML editor. You can drag and drop new manifest files as needed.

  You can also click the plus icon to add a new, untitled YAML file.

1. (Recommended) To deploy native Helm charts, set `useHelmInstall: true` in the HelmChart custom resource.

   :::note
   This is a chart level flag that is only supported for new charts. Modifying existing charts in existing applications is not supported.
   :::   

   For any existing installations of the application, you can update these in the Replicated admin console or using the kots CLI. After they are updated, any new Helm charts added to the application are deployed with the native Helm installation. After they are updated, any new Helm charts added to the application are deployed with the native Helm installation.

   For more information about adding charts to applications, see [optional charts](helm-optional-charts) and the [Helm docs](https://helm.sh/docs/topics/charts/). For information on ordering the Helm chart installations, see [Defining Installation Order for Native Helm Charts](https://docs.replicated.com/vendor/helm-native-helm-install-order).

   ![Use Helm Install Flag](/images/vendor-use-helm-install-flag.png)

1. Edit other YAML files as needed, and click **Save release**. This saves a draft that you can continue to edit until you promote it.

  :::note
  To edit a draft release, click **Edit YAML** from the Releases page.
  :::

1. Click **Promote**. In the Promote Release dialog that opens, edit the fields:

    <table>
      <tr>
        <th width="30%">Field</th>
        <th width="70%">Description</th>
      </tr>
      <tr>
        <td>Channel</td>
        <td>Select the channel where you want to promote the release. The defaults are Stable, Beta, and Unstable. If you created custom channels, they are listed here also.</td>
      </tr>
      <tr>
        <td>Version label</td>
        <td><p>Enter a version label.</p><p>If semantic versioning is enabled for the channel, you must use a valid semantic version using the X.Y.Z format, where X is the major version, Y is the minor version, and Z is the patch version. These must be non-negative integers and cannot contain leading zeroes. Each element must increase numerically.</p><p>For more information, see <a href="releases-about#enable-semantic-versioning">Enable Semantic Versioning</a> in <i>About Releases</i> and <a href="https://semver.org/">Semantic Versioning</a> on the Semantic Versioning website.</p></td>
      </tr>
      <tr>
        <td>Requirements</td>
        <td><p>Select <strong>Prevent this release from being skipped during upgrades</strong> to mark the release as required. When a release is required, the admin console requires users to upgrade to that version before they can upgrade to a later version.</p><p>For example, if you select <strong>Prevent this release from being skipped during upgrades</strong> for release v2.0.0, users with v1.0.0 deployed must upgrade to v2.0.0 before they can upgrade to a version later than v2.0.0, such as v2.1.0.</p><p>Required releases are supported in the app manager v1.68.0 and later.</p><p>After users deploy a required version, they can no longer redeploy (roll back to) versions earlier than the required version, even if <code>allowRollback</code> is <code>true</code> in the Application custom resource manifest. See <a href="../reference/custom-resource-application#allowrollback">allowRollback</a> in the <i>Application</i> custom resource topic.</p></td>
      </tr>
      <tr>
        <td>Release notes</td>
        <td>Add detailed release notes. The release notes support markdown and are shown to your customer.</td>
      </tr>
    </table>

1. Click **Promote**.

  The release appears in an **Active** state on the Releases page.

## Using the CLI {#cli}

### Prerequisites

<PrereqsCli/>

### Create and Promote a Release

This procedure shows how to create a new release using local application files and the replicated CLI.

To create and promote a new release:

1. Copy the Helm chart `.tgz` package to the local directory that contains the manifest files for the release.

1. Create a HelmChart custom resource manifest file in the same directory where you copied the `.tgz` file. Name the HelmChart manifest file `CHART_NAME.yaml`. For example, `postgresql.yaml`.

1. Copy and paste the following YAML into the HelmChart manifest:

   ```yaml
   apiVersion: kots.io/v1beta1
   kind: HelmChart
   metadata:
      # name matches the file name that you used.
      # If you saved the file as CHART_NAME.yaml, use name: CHART_NAME
      name: CHART_NAME
   spec:
   # chart identifies the Helm chart from the .tgz
   # Replace CHART_NAME with the name of the chart from the .tgz
   # Replace CHART_VERSION with the version of the chart from the .tgz
      chart:
         name: CHART_NAME
         chartVersion: CHART_VERSION

      # helmVersion identifies the version of Helm used to render the chart.
      # Possible values are v2 or v3.
      helmVersion: v3

      # useHelmInstall identifies whether this Helm chart uses the
      # Replicated Helm installation (false) or native Helm installation (true).
      # Native Helm installation is available for Helm v3 charts only.
       useHelmInstall: true

      # values maps user-provided values with the Helm chart values.yaml file.
      # You can leave the values attribute empty for this procedure.
      values: {}

      # builder values are used to create air gap packages.
      # You can leave the builder attribute empty for this procedure.
      builder: {}
   ```
   For more information, see [HelmChart](../reference/custom-resource-helmchart) in the _Custom Resources_ section.

1. Lint the manifest files and ensure that there are no errors in the YAML:

  ```bash
  replicated release lint --yaml-dir=PATH_TO_APP_DIR
  ```

  Replace `PATH_TO_APP_DIR` with path to the directory of the YAML manifest files.

  For more information about linting, see [release lint](/reference/replicated-cli-release-lint) and [Linter Rules](/reference/linter) in _Reference_.

1. Create a new release:

    ```bash
    replicated release create --yaml-dir PATH_TO_APP_DIR
    ```
    Replace `PATH_TO_APP_DIR` with the path to the directory of the YAML manifest files.

   For more information, see [release create](/reference/replicated-cli-release-create) or [release update](../reference/replicated-cli-release-update) in _Reference_.

1. Continue to edit and lint the release as needed, then update the release:

    ```
    replicated release update SEQUENCE --yaml-dir PATH-TO-APP-DIRECTORY
    ```
    Replace:
      
    -  `SEQUENCE` with the release sequence number. This identifies the existing release to be updated.
    -  `PATH_TO_APP_DIR` with the path to the directory of the YAML manifest files.

    For more information, see [release update](../reference/replicated-cli-release-update) in _Reference_.

1. Promote the release when you are ready to test it. Releases cannot be edited after they are promoted. To make changes after promotion, you have to create a new release.

    ```
    replicated release promote SEQUENCE CHANNEL_ID
    ```

    Replace:
      
    -  `SEQUENCE` with the release sequence number.
    -  `CHANNEL_ID` with the channel ID or case sensitive name of the channel.

    For more information, see [release promote](/reference/replicated-cli-release-promote) in the replicated CLI documentation.

1. Verify that the release was promoted to the channel:

  ```
  replicated release ls
  ```

## Next Steps

The following are the recommended next steps to test the application in your development environment:

- To add a customer, see [Creating a Customer](releases-creating-customer).
- If you are installing for the first time, see [Overview of Installing an Application with the App Manager](/enterprise/installing-overview) in the _Enterprise_ section. 
- If you are updating an existing installation, see [Updating an Application](../enterprise/updating-apps) in the _Enterprise_ section.