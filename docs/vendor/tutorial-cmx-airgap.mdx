import DependencyYaml from "../partials/replicated-sdk/_dependency-yaml.mdx"
import HelmPackage from "../partials/helm/_helm-package.mdx"
import Requirements from "../partials/embedded-cluster/_requirements.mdx"

# Test an Air Gap Installation with Compatibility Matrix

This tutorial demonstrates how to test an air gap installation of a Helm chart with Replicated Embedded Cluster. This tutorial uses Compatiblity Matrix (CMX) to create a VM that simulates an air-gapped environment with no outbound internet access.

## Introduction

In this tutorial, you will:

* Download the Helm chart and release manifests for the sample NGINX application
* Create a release for NGINX in the Replicated Platform
* Build the `.airgap` bundle for the release
* Create a VM with CMX, and set the VM's network policy to `airgap` to prevent outbound internet access
* Follow the Embedded Cluster air gap installation instructions to download the air gap bundle, transfer the bundle to the air-gapped VM, and then install with Embedded Cluster
* Make an outbound request from the NGINX app, and then view the attempt in the CMX network report

## Set Up Your Environment

Before you begin, do the following to set up your environment:

* Install the Helm CLI, which is the tool for interacting with Helm and managing Helm charts. See [Install Helm](/vendor/environment-setup#install-helm).

* Ensure that you have CMX credits. You can request credits by going to [**Compatibility Matrix > Request more credits**](https://vendor.replicated.com/compatibility-matrix) in the Vendor Portal. For more information about CMX credits, see [Billing and Credits](/vendor/testing-about#billing-and-credits).

    :::note
    If you are new to the Replicated platform, you might be eligible for $100 in free CMX credits. To request your free credits, reach out to our sales team at https://www.replicated.com/contact and note in the comments that you are completing a Replicated tutorial.
    :::
      
* Ensure that you have an SSH key in your GitHub account. Then, add your GitHub username to your Vendor Portal [**Account Settings**](https://vendor.replicated.com/account-settings). This will provide SSH access to VMs that you create with CMX. For more information, see [Set Up SSH Access](/vendor/testing-vm-create#set-up-ssh-access) in _Create VMs_.

After you complete the prerequisites above, continue to the [Tutorial](#tutorial). You will create the VM with CMX as part of the tutorial.

## Tutorial

### Create an Application

1. On your local machine, install the Replicated CLI:

   * MacOS

      ```bash
      brew install replicatedhq/replicated/cli
      ```
   * Linux / Windows Subsystem for Linux (WSL)

      ```bash
      version=$(curl -s https://api.github.com/repos/replicatedhq/replicated/releases/latest \
         | grep -m1 -Po '"tag_name":\s*"v\K[^"]+')
      curl -Ls \
         "https://github.com/replicatedhq/replicated/releases/download/v${version}/replicated_${version}_linux_amd64.tar.gz" \
         -o replicated.tar.gz
      tar xf replicated.tar.gz replicated && rm replicated.tar.gz
      mv replicated /usr/local/bin/replicated
      ``` 
   For more information and additional installation options, see [Install the Replicated CLI](/reference/replicated-cli-installing).

1. Authorize the Replicated CLI:

   ```bash
   replicated login
   ```
   In the browser window that opens, follow the prompt to log in to your Vendor Portal account and authorize the CLI.

1. Create an application NGINX:

   ```bash
   replicated app create "NGINX"
   ```

1. Set the `REPLICATED_APP` environment variable to the application that you created:

   ```bash
   export REPLICATED_APP=APP_SLUG
   ```
   Where `APP_SLUG` is the unique application slug provided in the output of the `app create` command.

   Setting the `REPLICATED_APP` environment variable allows you to interact with the application using the Replicated CLI without needing to use the `--app` flag with every command.  

### Create a Release

1. Run the following command to download a tarball containing the files for the release:

    ```bash
    curl -O --create-dirs --output-dir tutorial-airgap https://docs.replicated.com/nginx-0.1.0-release.tar.gz
    ```

1. Untar:

    ```bash
    tar -xzf tutorial-airgap/nginx-0.1.0-release.tar.gz
    ```

1. View the contents:

   ```bash
   ls
   ```
   ```bash
   ec-config.yaml      nginx-0.1.0.tgz          nginx.yaml             replicated-app.yaml
   ```
   The contents include the NGINX Helm chart archive (`nginx-0.1.0.tgz`) and some Replicated manifests that are used to define different aspects of the installation experience for the application.

1. Lint the YAML files in the directory:

   ```bash
   replicated release lint --yaml-dir .
   ```
   :::note
   You can ignore `info` or `warn` messages for the purpose of this tutorial.
   :::      

1. From the `tutorial-airgap` directory, create a release and promote it to the Unstable channel:

   ```bash
   replicated release create --yaml-dir . --promote Unstable
   ```
   **Example output**:
   ```bash
   • Reading manifests from . ✓
   • Creating Release ✓
      • SEQUENCE: 1
   • Promoting ✓
      • Channel 2kvjwEj4uBaCMoTigW5xty1iiw6 successfully set to release 1
   ```

### Build the Air Gap Bundle

1. In the Vendor Portal, go to **Channels**.

1. On the **Unstable** channel card, click **Release history**.

1. On the **Release history** page, find the release sequence that you just promoted.

1. Next to **Air gap not built**, click **Build**. You can also optionally click **View release image list** to see the NGINX image and the Replicated SDK image that Replicated will include in the air gap bundle.

    Wait for the air gap bundle to build. This can take a few minutes. After the bundle is built, continue to the next step.

    :::note
    You might need to refresh the page to get the latest air gap bundle build status.
    :::    

### Create a Customer

1. Log in to the [Vendor Portal](https://vendor.replicated.com).

1. Under the application drop down, select the NGINX application that you created.

   {/* <img alt="App drop down" src="/images/quick-start-app-dropdown-slackernews.png" width="250px"/>

   [View a larger version of this image](/images/quick-start-app-dropdown-slackernews.png) */}

1. Click **Customers > Create customer**.

   The **Create a new customer** page opens.

1. For **Customer name**, enter a name for the customer. For example, `Nitflex`.

1. For **Assigned Channel**, select **Unstable**. This allows the customer to install releases promoted to the Unstable channel.

1. For **Customer type**, select **Development**.

1. For **Install types**, enable **Embedded Cluster (current generation product)**.

1. For **Additional install options**, enable **Air Gap Installation Option (Replicated Installers only)**.

1. Click **Save Changes**.

### Download the Air Gap Release Assets

1. On the development customer's page, click **Embedded Cluster install instructions**.

1. Make sure that the **Install in an air gap environment** checkbox is enabled. This checkbox is automatically enabled when the customer license has the air gap install option. 

1. 

### Create a VM with CMX

1. In the Vendor Portal, go to [**Compatibility Matrix**](https://vendor.replicated.com/compatibility-matrix).

1. Click **Create > Create VM**.

   ![create vm page in the vendor portal](/images/compatibility-matrix-create-vm.png)
   
   [View a larger version of this image](/images/compatibility-matrix-create-vm.png)

1. On the **Create a Virtual Machine** page, complete the following fields:

     * **OS distribution**: Ubuntu
     * **Version**: 24.04
     * (Optional) **TTL**: Optionally increase the TTL for the VM if you want more time to test the installation. 

     Leave the default values for the remaining fields.

1. Click **Create VM**.

1. Open the dot menu for the target VM and click **Edit VM**.

   ![Edit VM in the dot menu](/images/compatibility-matrix-edit-vm.png)

   [View a larger version of this image](/images/compatibility-matrix-edit-vm.png)

1. Under **Ingress & Ports**, for **Add DNS record**, click **Add** to create a DNS record using the default settings. This will provide a hostname where you can optionally access the Admin Console after you install.

1. Add another DNS record with a **Target Port** of **80**. This will provide a hostname where you can access NGINX.

    The following shows an example of both of these DNS records added to a VM:

    ![DNS record for a VM](/images/compatibility-matrix-dns-record.png)
    [View a larger version of this image](/images/compatibility-matrix-dns-record.png)

1. Set the network policy for the VM to `airgap`. This will prevent outbound internet requests from the VM, allowing you to simulate an air-gapped installation environment.

1. Enable network reporting.

### SSH Onto the VM and Transfer the Air Gap Installation Assets

1. In the Vendor Portal, find the VM under the list **Virtual Machines**.

1. Copy and run the SSH command provided.

    ![ssh command for the vm](/images/compatibility-matrix-ssh-command.png)
    [View a larger version of this image](/images/compatibility-matrix-ssh-command.png)

1. If you are prompted to add the fingerprint for replicatedvm.com, type `yes` and press Enter.

1. When prompted, provide the passphrase for the SSH key in your linked GitHub account. CMX uses GitHub SSH to provide access to the VM.

1. Open a new command prompt window.

1. In the new window, get the SCP endpoint for the VM:

    ```bash
    replicated vm scp-endpoint VM_ID
    ```
    **Example output:**
    ```bash
    scp://yourusername@37.27.52.178:43663
    ```

1. Transfer the installation assets `.tgz` that you downloaded to your VM using the SCP endpoint:

    ```bash
    scp PATH_TO_TGZ scp://GITHUB_USERNAME@SSH_ENDPOINT:PORT 
    ```
    Where:
    * `PATH_TO_TGZ` is the path to the installation assets `.tgz` that you downloaded.
    * `GITHUB_USERNAME`, `SSH_ENDPOINT`, and `PORT` are all copied from the SCP endpoint that you retrieved.

    **Example:**
    ```bash
    scp nginx-unstable.tgz scp://yourusername@37.27.52.178:43663 
    ```
1. When prompted, type `yes` to connect to the host.

1. When prompted, type your passphrase for your SSH key and press Enter.

    Wait for the `.tgz` to transfer to your VM. This can take a few minutes.

1. Return to your VM and confirm that the `.tgz` was transferred.

### Extract the Air Gap Install Assets and Install

1. In the **Embedded cluster install instructions** dialog, copy the second command. Run it on your VM to extract to extract the installation assets.

1. Copy the `install` command from the dialog.

1. Run the command to install.

1. When prompted, set a password for accessing the Admin Console. Be sure to remember the password that you chose; you will use it to log in to the Admin Console in a later step.

   The installation takes a few minutes to complete.

1. After the installation command completes, open a shell so that you can interact with the cluster with the kubectl command line:

   ```
   sudo ./APP_SLUG shell
   ```

1. See that the NGINX pod is `running`:

   ```bash
   kubectl get pods --namespace kotsadm
   ```

### Access the Admin Console

1. The Admin Console domain is the hostname for the DNS record with port 30000 that you added to the VM. You can find this hostname by going to **Compatibility Matrix > Edit VM** in the Vendor Portal.

1. Log in to the Admin Console using the password that you set during installation.

### Access the NGINX App and Attempt an Outbound Request

1. The NGINX app domain is the hostname for the DNS record with port 80 that you added to the VM. You can find this hostname by going to **Compatibility Matrix > Edit VM** in the Vendor Portal.

1. On the NGINX app webpage, click the button to make an outbound internet request.



### Clean Up

* Delete the VM:

    ```bash
    replicated vm rm VM_ID
    ```

    Where `VM_ID` is the ID of the VM. You can run `replicated vm ls` to get the ID.

## Summary

Congratulations! As part of this tutorial, you:

* 
* 
*