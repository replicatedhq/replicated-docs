import DependencyYaml from "../partials/replicated-sdk/_dependency-yaml.mdx"
import HelmPackage from "../partials/helm/_helm-package.mdx"
import Requirements from "../partials/embedded-cluster/_requirements.mdx"

# Test an Air Gap Installation with Compatibility Matrix

This tutorial demonstrates how to test an air gap installation of a Helm chart using Replicated Embedded Cluster and Replicated Compatiblity Matrix (CMX).

## Introduction

Replicated's Compatibility Matrix includes network policy and network reporting features that allow vendors to quickly provision air-gapped envrionments and to report on network activity. These features help vendors that distribute applications into customer environments with little or no outbound internet access to test their releases for any outbound network requests (or any outbound requests to domains that are not on the customer's allowlist).

In this tutorial, you will do the following to learn more about the CMX network policy and reporting features:

* Download the Helm chart and release manifests for a sample NGINX application
* Create a release for NGINX in the Replicated Platform
* Build the `.airgap` bundle for the release
* Create a VM with CMX, and set the VM's network policy to `airgap` to simulate an air-gapped environment
* Follow the Embedded Cluster air gap installation instructions to download the air gap bundle, transfer the bundle to the air-gapped VM, and then install with Embedded Cluster
* Make an outbound request from the NGINX app, and then view the attempt in the CMX network report

## Set Up Your Environment

Before you begin, do the following to set up your environment:

* Install the Helm CLI, which is the tool for interacting with Helm and managing Helm charts. See [Install Helm](/vendor/environment-setup#install-helm).

* Ensure that you have CMX credits. You can request credits by going to [**Compatibility Matrix > Request more credits**](https://vendor.replicated.com/compatibility-matrix) in the Vendor Portal. For more information about CMX credits, see [Billing and Credits](/vendor/testing-about#billing-and-credits).

    :::note
    If you are new to the Replicated platform, you might be eligible for $100 in free CMX credits. To request your free credits, reach out to our sales team at https://www.replicated.com/contact and note in the comments that you are completing a Replicated tutorial.
    :::
      
* Ensure that you have an SSH key in your GitHub account. Then, add your GitHub username to your Vendor Portal [**Account Settings**](https://vendor.replicated.com/account-settings). This will provide SSH access to VMs that you create with CMX. For more information, see [Set Up SSH Access](/vendor/testing-vm-create#set-up-ssh-access) in _Create VMs_.

After you complete the prerequisites above, continue to the [Tutorial](#tutorial). You will create the VM with CMX as part of the tutorial.

## Tutorial

### Create an Application

1. On your local machine, install the Replicated CLI:

   * MacOS

      ```bash
      brew install replicatedhq/replicated/cli
      ```
   * Linux / Windows Subsystem for Linux (WSL)

      ```bash
      version=$(curl -s https://api.github.com/repos/replicatedhq/replicated/releases/latest \
         | grep -m1 -Po '"tag_name":\s*"v\K[^"]+')
      curl -Ls \
         "https://github.com/replicatedhq/replicated/releases/download/v${version}/replicated_${version}_linux_amd64.tar.gz" \
         -o replicated.tar.gz
      tar xf replicated.tar.gz replicated && rm replicated.tar.gz
      mv replicated /usr/local/bin/replicated
      ``` 
   For more information and additional installation options, see [Install the Replicated CLI](/reference/replicated-cli-installing).

1. Authorize the Replicated CLI:

   ```bash
   replicated login
   ```
   In the browser window that opens, follow the prompt to log in to your Vendor Portal account and authorize the CLI.

1. Create an application NGINX:

   ```bash
   replicated app create "NGINX"
   ```

1. Set the `REPLICATED_APP` environment variable to the application that you created:

   ```bash
   export REPLICATED_APP=APP_SLUG
   ```
   Where `APP_SLUG` is the unique application slug provided in the output of the `app create` command.

   Setting the `REPLICATED_APP` environment variable allows you to interact with the application using the Replicated CLI without needing to use the `--app` flag with every command.  

### Create a Release

1. Run the following command to download a tarball containing the files for the release:

    ```bash
    curl -O --create-dirs --output-dir tutorial-airgap https://docs.replicated.com/nginx-0.1.0-release.tar.gz
    ```

1. Untar:

    ```bash
    tar -xzf tutorial-airgap/nginx-0.1.0-release.tar.gz
    ```

1. View the contents:

   ```bash
   ls
   ```
   ```bash
   ec-config.yaml      nginx-0.1.0.tgz          nginx.yaml             replicated-app.yaml
   ```
   The contents include the NGINX Helm chart archive (`nginx-0.1.0.tgz`) and some Replicated manifests that are used to define different aspects of the installation experience for the application.

1. Lint the YAML files in the directory:

   ```bash
   replicated release lint --yaml-dir .
   ```
   :::note
   You can ignore `info` or `warn` messages for the purpose of this tutorial.
   :::      

1. From the `tutorial-airgap` directory, create a release and promote it to the Unstable channel:

   ```bash
   replicated release create --yaml-dir . --promote Unstable
   ```
   **Example output**:
   ```bash
   • Reading manifests from . ✓
   • Creating Release ✓
      • SEQUENCE: 1
   • Promoting ✓
      • Channel 2kvjwEj4uBaCMoTigW5xty1iiw6 successfully set to release 1
   ```

### Build the Air Gap Bundle

1. Log in to the [Vendor Portal](https://vendor.replicated.com).

1. In the application drop down, select the NGINX application that you created.

   <img alt="App drop down" src="/images/nginx-vendor-portal-app-dropdown.png" width="250px"/>

   [View a larger version of this image](/images/nginx-vendor-portal-app-dropdown.png)

1. Go to **Channels**.

1. On the **Unstable** channel card, in the **Latest release** section, click **Release history**.

1. On the **Release history** page, find the release sequence that you just promoted.

    ![release sequence 1 on the release history page](/images/nginx-airgap-not-built.png)
    [View a larger version of this image](/images/nginx-airgap-not-built.png)

1. (Optional) Click **View release image list** to see the images that Replicated will include in the air gap bundle. This release includes an NGINX image and the Replicated SDK image.

1. Next to **Air gap not built**, click **Build**.

    Wait a few minutes for the air gap bundle to build.

    :::note
    You might need to refresh the page to get the latest air gap bundle build status.
    :::    

### Create a Customer

1. Click **Customers > Create customer**.

   The **Create a new customer** page opens.

1. For **Customer name**, enter a name for the customer. For example, `Nitflex`.

1. For **Assigned Channel**, select **Unstable**. This allows the customer to install releases promoted to the Unstable channel.

1. For **Customer type**, select **Development**.

1. For **Install types**, enable **Embedded Cluster (current generation product)**.

1. For **Additional install options**, enable **Air Gap Installation Option (Replicated Installers only)**.

1. Click **Save Changes**.

### Download the Installation Assets

1. On the page for the customer you just created, click **Embedded Cluster install instructions**.

   ![Nitflex example customer page](/images/nginx-nitflex-customer.png)
   [View a larger version of this image](/images/nginx-nitflex-customer.png)

1. In the **Embedded Cluster install instructions** dialog, verify that the **Install in an air gap environment** checkbox is enabled. This checkbox is automatically enabled when the customer license has the air gap install option. 

   <img alt="Embedded Cluster install instructions" src="/images/nginx-ec-install-instructions-dialog.png" width="500px"/>
   [View a larger version of this image](/images/nginx-ec-install-instructions-dialog.png)

1. On your command prompt, run the first command in the dialog to download the Embedded Cluster air gap installation assets.

    The installation assets include the air gap bundle that you built, the customer's license file, and Embedded Cluster binary.
    
    It can take a few minutes to download the `.tgz`.

### Create a VM with CMX

1. In the Vendor Portal, go to [**Compatibility Matrix**](https://vendor.replicated.com/compatibility-matrix).

1. Click **Create > Create VM**.

1. On the **Create a Virtual Machine** page, complete the following fields:

     * **OS distribution**: Ubuntu
     * **Version**: 24.04
     * (Optional) **TTL**: Optionally increase the TTL for the VM if you want more time to test the installation. 

     Leave the default values for the remaining fields.

1. Click **Create VM**.

1. Open the dot menu for the target VM and click **Edit VM**.

   ![Edit VM in the dot menu](/images/compatibility-matrix-edit-vm.png)

   [View a larger version of this image](/images/compatibility-matrix-edit-vm.png)

1. Under **Ingress & Ports**, for **Add DNS record**, click **Add** to create a DNS record with a **Target Port** of **30000**.

1. Add another DNS record with a **Target Port** of **80**.

    The following shows an example of both of these DNS records added to a VM:

    ![DNS record for a VM](/images/nginx-cmx-ports.png)
    [View a larger version of this image](/images/nginx-cmx-ports.png)

1. Copy both of the URLs under **DNS Name** for the records that you created, and save them somewhere on your local machine. You will access the Admin Console and the NGINX app at these URLs after you install.

1. In the panel on the left side of the screen, click **Network Policy**.

   ![DNS record for a VM](/images/cmx-vm-network-policy-table.png)
    [View a larger version of this image](/images/cmx-vm-network-policy-table.png)

1. On the **Network Policy** page, for the network where your VM is connected, set **Policy Type** to `airgap`. This prevents outbound internet requests from the VM, allowing you to simulate an air-gapped installation environment.

1. Then, toggle **Reporting** for the network to **on**. This allows you to view a network report for the air-gapped VM, which includes details about all connection attempts and DNS queries.

### SSH Onto the VM and Transfer the Installation Assets

1. In the panel on the left side of the screen, click **Overview** to return to the Compatibility Matrix **Overview** page.

1. Under **Virtual Machines**, copy the SSH command provided for your VM.

    ![ssh command for the vm](/images/compatibility-matrix-ssh-command.png)
    [View a larger version of this image](/images/compatibility-matrix-ssh-command.png)

1. On your command prompt, run the SSH command.

1. If you are prompted to add the fingerprint for replicatedvm.com, type `yes` and press Enter.

1. When prompted, provide the passphrase for the SSH key in your linked GitHub account. CMX uses GitHub SSH to provide access to the VM.

1. Open a new command prompt window.

1. In the new window, get the SCP endpoint for the VM:

    ```bash
    replicated vm scp-endpoint VM_ID
    ```
    Where `VM_ID` is the ID for your VM. You can get the ID by running `replicated vm ls`.

    **Example output:**
    ```bash
    scp://yourusername@37.27.52.178:43663
    ```

1. Transfer the `.tgz` installation assets that you downloaded as part of [Download the Installation Assets](#download-the-installation-assets) to your VM using the SCP endpoint:

    ```bash
    scp PATH_TO_TGZ scp://GITHUB_USERNAME@SSH_ENDPOINT:PORT 
    ```
    Where:
    * `PATH_TO_TGZ` is the path to the `.tgz` installation assets that you downloaded.
    * `GITHUB_USERNAME`, `SSH_ENDPOINT`, and `PORT` are all copied from the SCP endpoint that you retrieved.

    **Example:**
    ```bash
    scp nginx-unstable.tgz scp://yourusername@37.27.52.178:43663 
    ```
1. When prompted, type `yes` to connect to the host.

1. When prompted, type your passphrase for your SSH key and press Enter.

    Wait for the `.tgz` to transfer to your VM. This can take a few minutes.

### Extract the Installation Assets and Install NGINX

1. In the Vendor Portal, go back to the customer's page and reopen the **Embedded cluster install instructions** dialog.

1. Copy the **Extract the installation assets** command and run it on your VM to extract the `.tgz` that you transferred.

1. Copy and run the `install` command.

1. When prompted, set a password for accessing the Admin Console. Remember the password that you set; you will use it to log in to the Admin Console in a later step.

   The installation takes a few minutes to complete.

1. After the installation completes, open a shell so that you can interact with the cluster with kubectl:

   ```
   sudo ./APP_SLUG shell
   ```
   Where `APP_SLUG` is the slug for your application.

1. Use kubectl to verify that the NGINX pod is `running`:

   ```bash
   kubectl get pods --namespace kotsadm
   ```
   ```bash
   kotsadm-7c6457b99c-gjfz6             1/1     Running   0              37s
   kotsadm-rqlite-0                     1/1     Running   0              2m1s
   kurl-proxy-kotsadm-b9fdfdb7f-sxk7w   1/1     Running   1              2m1s
   nginx-6d58d68945-nbbzx               1/1     Running   0              29s
   replicated-6798d88b48-b6575          1/1     Running   0              29s
   ```

1. (Optional) In a browser, go to the URL for the Admin Console. This is the URL for the DNS record that you created with a target port of 30000 as part of [Create a VM with CMX](#create-a-vm-with-cmx). You can find the URL by going to **Compatibility Matrix > Edit VM > Ingress & Ports** in the Vendor Portal. Log in to the Admin Console using the password that you set during installation. 

     On the Admin Console landing page, you can see the app version that you deployed, and that the NGINX app is **Ready**.

     ![admin console landing page](/images/nginx-airgap-admin-console.png)
     [View a larger version of this image](/images/nginx-airgap-admin-console.png)

### Access the NGINX App and View the Network Report

1. Get the ID for the air gap network that your VM is connected to:

   ```
   replicated network ls
   ```

1. Run the following command to watch the network report:

   ```
   replicated network report NETWORK_ID --watch
   ```  
   Where `NETWORK_ID` is the ID of the network.

1. In a browser, go to the URL for the NGINX app. This is the URL for the DNS record with a target port of 80 that you created as part of [Create a VM with CMX](#create-a-vm-with-cmx).

   :::note
   You can find the URL by going to **Compatibility Matrix > Edit VM > Ingress & Ports** in the Vendor Portal.
   :::

1. On the NGINX app webpage, click **Test Outbound Request** to make an outbound network request to `http://httpbin.org`. As shown below, the webpage displays an **Egress blocked** warning message because the `airgap` network policy for the VM does not allow outbound requests.

    <img alt="egress blocked error" src="/images/nginx-egress-blocked.png" width="600px"/>
     [View a larger version of this image](/images/nginx-egress-blocked.png)

1. On your command prompt where you are watching network activity for the VM, note that you can see a network event similar to the following, which records the request to `httpbin.org`:

    ```bash
    {"timestamp":"2026-01-14T21:31:32.023130266Z","srcIp":"10.244.26.14","dstIp":"1.1.1.1","srcPort":59247,"dstPort":53,"proto":"UDP","comm":"nginx","pid":8641,"likelyService":"dns","dnsQueryName":"httpbin.org"}
    ```

1. In the Vendor Portal, go to **Compatibility Matrix > Network Policy** and click **View report** for the network where your VM is connected.

1. Under **Domain Names Requested**, note that the `httpbin.org` domain is listed in the table along with the number of requests made.

### Clean Up

* Delete the VM:

    ```bash
    replicated vm rm VM_ID
    ```

    Where `VM_ID` is the ID of the VM. You can run `replicated vm ls` to get the ID.

## Summary

Congratulations! As part of this tutorial, you:

* Performed an air gap installation with Embedded Cluster in a VM
* Used the Compatibility Matrix network policy feature to create an air-gapped VM
* Used the Compatibility Matrix network reporting feature to record outbound network requests made by an application

For more information about testing with Compatibility Matrix in air-gapped environments, see [Test in Air Gap Environments](/vendor/testing-network-policy).

For more information about installing in air-gapped environments with Embedded Cluster, see [Air Gap Installation with Embedded Cluster](/enterprise/installing-embedded-air-gap).