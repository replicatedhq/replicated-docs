import Deprecated from "../partials/helm/_replicated-deprecated.mdx"
import StepCreds from "../partials/proxy-service/_step-creds.mdx"
import StepCustomDomain from "../partials/proxy-service/_step-custom-domain.mdx"

# Use the Proxy Registry with Replicated Installers

This topic describes how to use the Replicated proxy registry with applications deployed with Replicated installers (KOTS, kURL, and Embedded Cluster).

## Overview

For applications installed with a Replicated installer, Replicated KOTS automatically creates the required image pull secret for accessing the Replicated proxy registry during application deployment. When possible, KOTS also automatically rewrites image names in the application manifests to the location of the image at `proxy.replicated.com` or your custom domain.  

### About the Image Pull Secret

During application deployment, KOTS automatically creates an `imagePullSecret` with `type: kubernetes.io/dockerconfigjson` that is based on the customer license. This secret is used to authenticate with the proxy registry and grant proxy access to private images.

For information about how Kubernetes uses the `kubernetes.io/dockerconfigjson` Secret type to authenticate to a private image registry, see [Pull an Image from a Private Registry](https://kubernetes.io/docs/tasks/configure-pod-container/pull-image-private-registry/) in the Kubernetes documentation.

### About Image Location Patching (HelmChart v1 and Standard Manifests)

For applications packaged with the [HelmChart v1](/reference/custom-resource-helmchart) custom resource or with standard Kubernetes manifests, KOTS automatically patches image names to the location of the image at `proxy.replicated.com` or your custom domain during deployment. If KOTS receives a 401 response when attempting to load image manifests using the image reference from the PodSpec, it assumes that this is a private image that must be proxied through the proxy registry.

KOTS uses Kustomize to patch the `midstream/kustomization.yaml` file to change the image name during deployment to reference the proxy registry. For example, a PodSpec for a Deployment references a private image hosted at `quay.io/my-org/api:v1.0.1`:

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: example
spec:
  template:
    spec:
      containers:
        - name: api
          image: quay.io/my-org/api:v1.0.1
```

When this application is deployed, KOTS detects that it cannot access
the image at quay.io. So, it creates a patch in the `midstream/kustomization.yaml`
file that changes the image name in all manifest files for the application. This causes the container runtime in the cluster to use the proxy registry to pull the images, using the license information provided to KOTS for authentication.

```yaml
apiVersion: kustomize.config.k8s.io/v1beta1
bases:
- ../../base
images:
- name: quay.io/my-org/api:v1.0.1
  newName: proxy.replicated.com/proxy/my-kots-app/quay.io/my-org/api
```

## Use the Proxy Registry

This section describes how to configure your application to use the proxy registry.

### HelmChart v2

To enable the proxy registry with applications deployed with HelmChart v2:

1. <StepCreds/>

1. <StepCustomDomain/>

1. In your Helm chart values file, set your image repository URL to the location of the image on the proxy registry. If you added a custom domain, use your custom domain. Otherwise, use `proxy.replicated.com`.

      The proxy registry URL has the following format: `DOMAIN/proxy/APP_SLUG/EXTERNAL_REGISTRY_IMAGE_URL`
      
      Where:
      * `DOMAIN` is either `proxy.replicated.com` or your custom domain.
      * `APP_SLUG` is the unique slug of your application.
      * `EXTERNAL_REGISTRY_IMAGE_URL` is the path to the private image on your external registry.
      
      **Example:**

      ```yaml
      # values.yaml
      api:
        image:
          # proxy.registry.com or your custom domain
          registry: ghcr.io
          repository: proxy/app/ghcr.io/cloudnative-pg/cloudnative-pg
          tag: catalog-1.24.0
      ```

1. Ensure that any references to the image in your Helm chart access the field from your values file.  

   **Example**:

    ```yaml
    apiVersion: v1
    kind: Pod
    spec:
      containers:
        - name: api 
            # Access the registry, repository, and tag fields from the values file
            image: {{ .Values.images.api.registry }}/{{ .Values.images.api.repository }}:{{ .Values.images.api.tag }}
    ```

1. In the KOTS HelmChart custom resource, under the `values` key, use the KOTS [ImagePullSecretName](/reference/template-functions-config-context#imagepullsecretname) template function to set the image pull secret for any private images to the KOTS-generated image pull secret.

    **Example:**

    ```yaml
    # KOTS HelmChart custom resource

    apiVersion: kots.io/v1beta2
    kind: HelmChart
    metadata:
      name: samplechart
    spec:
      values:
        postgres:
          image:
            # Inject the pull secret with ImagePullSecretName
            imagePullSecrets:
              - name: '{{repl ImagePullSecretName }}'
    ```

1. If you are deploying Pods to namespaces other than the application namespace, add the namespace to the `additionalNamespaces` attribute of the KOTS Application custom resource. This ensures that KOTS can provision the `imagePullSecret` in the namespace to allow the Pod to pull the image. For instructions, see [Define Additional Namespaces](operator-defining-additional-namespaces).


### HelmChart v1 or Standard Manifests

:::note
<Deprecated/>
:::

To use the proxy registry with applications deployed with HelmChart v1 or packed with standard manifests:

1. <StepCreds/>

1. <StepCustomDomain/>

1. If you are deploying Pods to namespaces other than the application namespace, add the namespace to the `additionalNamespaces` attribute of the KOTS Application custom resource. This ensures that KOTS can provision the `imagePullSecret` in the namespace to allow the Pod to pull the image. For instructions, see [Define Additional Namespaces](operator-defining-additional-namespaces).

For standard manifest-based applications or Helm charts deployed with the [HelmChart v1](/reference/custom-resource-helmchart), KOTS automatically rewrites image names and injects image pull secrets during deployment for these application types. No additional configuration is required.

### Kubernetes Operators

To use the proxy registry with applications packaged with Kubernetes Operators:

1. <StepCreds/>

1. <StepCustomDomain/>

1. If you are deploying Pods to namespaces other than the application namespace, add the namespace to the `additionalNamespaces` attribute of the KOTS Application custom resource. This ensures that KOTS can provision the `imagePullSecret` in the namespace to allow the Pod to pull the image. For instructions, see [Define Additional Namespaces](operator-defining-additional-namespaces).

1. For applications packaged with Kubernetes Operators, KOTS cannot modify pods that are created at runtime by the Operator. To support the use of private images in all environments, the Operator code should use KOTS functionality to determine the image name and image pull secrets for all pods when they are created. For instructions, see [Reference Images](/vendor/operator-referencing-images) in the _Packaging Kubernetes Operators_ section.