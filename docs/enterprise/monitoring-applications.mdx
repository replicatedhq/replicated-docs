import OverviewProm from "../partials/monitoring/_overview-prom.mdx"
import LimitationEc from "../partials/monitoring/_limitation-ec.mdx"

# Monitoring Applications with Prometheus

This topic describes how to monitor applications and clusters with Prometheus in existing cluster installations with Replicated KOTS.

For information about consuming Prometheus metrics externally in Replicated kURL installations, see [Consuming Prometheus Metrics Externally](monitoring-external-prometheus).

## Overview

<OverviewProm/>

To configure Prometheus monitoring for applications installed with KOTS in an existing cluster, you can connect the Admin Console to the endpoint of an instance of Prometheus installed in the cluster.

## Limitation

<LimitationEc/>

## Install Prometheus in the Cluster {#configure-existing}

Replicated recommends that you use CoreOS's Kube-Prometheus distribution for installing and configuring highly available Prometheus on an existing cluster. For more information, see the [kube-prometheus](https://github.com/coreos/kube-prometheus) GitHub repository.

This repository collects Kubernetes manifests, Grafana dashboards, and Prometheus rules combined with documentation and scripts to provide easy to operate end-to-end Kubernetes cluster monitoring with Prometheus using the Prometheus Operator.

To install Prometheus using the recommended Kube-Prometheus distribution:

1. Clone the [kube-prometheus](https://github.com/coreos/kube-prometheus) repository to the device where there is access to the cluster.

1. Use `kubectl` to create the resources on the cluster:

   ```bash
   # Create the namespace and CRDs, and then wait for them to be available before creating the remaining resources
   kubectl create -f manifests/setup
   until kubectl get servicemonitors --all-namespaces ; do date; sleep 1; echo ""; done
   kubectl create -f manifests/
   ```

   For advanced and cluster-specific configuration, you can customize Kube-Prometheus by compiling the manifests using jsonnet. For more information, see the [jsonnet website](https://jsonnet.org/).

   For more information about advanced Kube-Prometheus configuration options, see [Customizing Kube-Prometheus](https://github.com/coreos/kube-prometheus#customizing-kube-prometheus) in the kube-prometheus GitHub repository.

## Connect to a Prometheus Endpoint

To view graphs on the Admin Console dashboard, provide the address of a Prometheus instance installed in the cluster.

To connect the Admin Console to a Prometheus endpoint:

1. On the Admin Console dashboard, under Monitoring, click **Configure Prometheus Address**.
1. Enter the address for the Prometheus endpoint in the text box and click **Save**.

   ![Configuring Prometheus](/images/kotsadm-dashboard-configureprometheus.png)

   Graphs appear on the dashboard shortly after saving the address.

## Access the Dashboards Using Port Forwarding

You can access Prometheus, Grafana, and Alertmanager dashboards using `kubectl port-forward` after you install the manifests.

You can also expose these pods on NodePorts or behind an ingress controller. This is an advanced use case. For information about exposing the pods on NodePorts, see [NodePorts](https://github.com/prometheus-operator/kube-prometheus/blob/main/docs/customizations/node-ports.md) in the kube-prometheus GitHub repository. For information about exposing the pods behind an ingress controller, see [Expose via Ingress](https://github.com/prometheus-operator/kube-prometheus/blob/main/docs/customizations/exposing-prometheus-alertmanager-grafana-ingress.md) in the kube-prometheus GitHub repository.

### Access Prometheus

To access the Prometheus dashboard:

1. Run the following command to port forward the Prometheus service:

   ```bash
   kubectl --namespace monitoring port-forward svc/prometheus-k8s 9090
   ```

1. Access the dashboard at http://localhost:9090.

### Access Grafana

To access the Grafana dashboard:

1. Run the following command to port forward the Grafana service:

   ```bash
   kubectl --namespace monitoring port-forward deployment/grafana 3000
   ```
1. Access the dashboard at http://localhost:3000.
1. Log in to Grafana:
   * **Existing cluster**: Use the default Grafana username and password: `admin:admin`.
   * **kURL  cluster**: The Grafana password is randomly generated by kURL and is displayed on the command line after kURL provisions the cluster. To log in, use this password generated by kURL and the username `admin`.

      To retrieve the password, run the following kubectl command:

      ```
      kubectl get secret -n monitoring grafana-admin -o jsonpath="{.data.admin-password}" | base64 -d
      ```

### Access Alertmanager

To access the Alertmanager dashboard:

1. Run the following command to port forward the Alertmanager service:

   ```
   kubectl --namespace monitoring port-forward svc/prometheus-alertmanager 9093
   ```

1. Access the dashboard at http://localhost:9093.

## About Visualizing Metrics with Grafana

In addition to the Prometheus Expression Browser, Grafana and some preconfigured dashboards are included with Kube-Prometheus for advanced visualization.

For information about configuring Grafana, see the [Grafana documentation](https://grafana.com/docs/).

For information about constructing Prometheus queries, see the [Querying Prometheus](https://prometheus.io/docs/prometheus/latest/querying/basics/) in the Prometheus documentation.

For information about the Prometheus Expression Browser, see [Expression Browser](https://prometheus.io/docs/visualization/browser/) in the Prometheus documentation.


## About Alerting with Prometheus

Alerting with Prometheus has two phases:

1. Alerting rules in Prometheus servers send alerts to an Alertmanager.
1. The Alertmanager then manages those alerts, including silencing, inhibition, aggregation, and sending out notifications through methods such as email, on-call notification systems, and chat platforms.

For more information about configuring Alertmanager, see [Configuration](https://prometheus.io/docs/alerting/configuration/) in the Prometheus documentation.